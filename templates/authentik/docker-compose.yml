x-arcane:
  icon: https://cdn.jsdelivr.net/gh/selfhst/icons@main/svg/authentik.svg
  urls:
    - https://goauthentik.io

services:
  authentik-database:
    image: postgres:17-alpine
    container_name: authentik-database
    restart: unless-stopped
    # ports:
    #   - "5432:5432"  # PostgreSQL (내부 통신만 사용, 외부 노출 불필요)
    environment:
      POSTGRES_DB: ${AUTHENTIK_PG_DB:-authentik}
      POSTGRES_USER: ${AUTHENTIK_PG_USER:-authentik}
      POSTGRES_PASSWORD: ${AUTHENTIK_PG_PASS:?database password required}
      # 인코딩 설정 추가
      LANG: C.UTF-8
      LC_ALL: C.UTF-8
    command:
      - postgres
      - -c
      - max_connections=200
      - -c
      - shared_buffers=256MB
    healthcheck:
      interval: 30s
      retries: 5
      start_period: 20s
      test:
      - CMD-SHELL
      - pg_isready -d $${POSTGRES_DB} -U $${POSTGRES_USER}
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    volumes:
      - authentik_database:/var/lib/postgresql/data
    networks:
      - database

  authentik:
    image: ghcr.io/goauthentik/server:${AUTHENTIK_TAG:-2025.10}
    container_name: authentik
    command: server
    restart: unless-stopped
    #ports:
    #  - "9000:9000"  # Authentik Web UI (Traefik을 통해 접근, 직접 노출 불필요)
    #  - "9443:9443"  # Authentik HTTPS (미사용)
    depends_on:
      authentik-database:
        condition: service_healthy
    environment:
      AUTHENTIK_INSECURE: "true"
      AUTHENTIK_POSTGRESQL__HOST: authentik-database
      AUTHENTIK_POSTGRESQL__NAME: ${AUTHENTIK_PG_DB:-authentik}
      AUTHENTIK_POSTGRESQL__USER: ${AUTHENTIK_PG_USER:-authentik}
      AUTHENTIK_POSTGRESQL__PASSWORD: ${AUTHENTIK_PG_PASS:?secret key required}
      AUTHENTIK_SECRET_KEY: ${AUTHENTIK_SECRET_KEY:?secret key required}
      AUTHENTIK_HOST: ${AUTHENTIK_DOMAIN}
      AUTHENTIK_COOKIE_DOMAIN: gurm.io
      AUTHENTIK_LISTEN__TRUSTED_PROXY_IPS: "127.0.0.0/8,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16"
      AUTHENTIK_LOG_LEVEL: ${AUTHENTIK_LOG_LEVEL:-warn}
    labels:
      - "traefik.enable=true"
      # Authentik 자체 접근 라우터
      - "traefik.http.routers.authentik.rule=Host(`${AUTHENTIK_HOST_NAME}`)"
      - "traefik.http.routers.authentik.entrypoints=web"
      - "traefik.http.services.authentik.loadbalancer.server.port=9000"
      # ForwardAuth 미들웨어 정의 (다른 서비스에서 참조)
      - "traefik.http.middlewares.authentik.forwardauth.address=http://authentik:9000/outpost.goauthentik.io/auth/traefik"
      - "traefik.http.middlewares.authentik.forwardauth.trustForwardHeader=true"
      - "traefik.http.middlewares.authentik.forwardauth.authResponseHeaders=X-authentik-username,X-authentik-groups,X-authentik-entitlements,X-authentik-email,X-authentik-name,X-authentik-uid,X-authentik-jwt,X-authentik-meta-jwks,X-authentik-meta-outpost,X-authentik-meta-provider,X-authentik-meta-app,X-authentik-meta-version"
    healthcheck:
      test: ["CMD", "ak", "healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 5
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    volumes:
      - authentik_data:/data
      - authentik_templates:/templates
    networks:
      - proxy
      - database
    
  authentik-worker:
    image: ghcr.io/goauthentik/server:${AUTHENTIK_TAG:-2025.10}
    container_name: authentik-worker
    command: worker
    restart: unless-stopped
    #user: root # Docker Socket 접근을 위해 root 필요
    # ports: (Worker는 포트 노출 없음)
    depends_on:
      authentik-database:
        condition: service_healthy
      authentik:
        condition: service_healthy
    environment:
      DOCKER_HOST: tcp://docker-socket:2375
      AUTHENTIK_POSTGRESQL__HOST: authentik-database
      AUTHENTIK_POSTGRESQL__NAME: ${AUTHENTIK_PG_DB:-authentik}
      AUTHENTIK_POSTGRESQL__USER: ${AUTHENTIK_PG_USER:-authentik}
      AUTHENTIK_POSTGRESQL__PASSWORD: ${AUTHENTIK_PG_PASS:?database password required}
      AUTHENTIK_SECRET_KEY: ${AUTHENTIK_SECRET_KEY:?secret key required}
      AUTHENTIK_LOG_LEVEL: ${AUTHENTIK_LOG_LEVEL:-warn}
    healthcheck:
      test: ["CMD", "ak", "healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    volumes:
    - authentik_data:/data
    - authentik_certs:/certs
    - authentik_templates:/templates
    networks:
    - proxy
    - database
    - docker-socket

volumes:
    authentik_database:
      name: authentik_database
      driver: local
    authentik_data:
      name: authentik_data
      driver: local
    authentik_certs:
      name: authentik_certs
      driver: local
    authentik_templates:
      name: authentik_templates
      driver: local

networks:
  proxy:
    external: true
  database:
    external: true
  docker-socket:
    external: true